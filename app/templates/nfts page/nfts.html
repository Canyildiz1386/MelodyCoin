<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFTs Page</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nfts.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Aldrich&display=swap" rel="stylesheet">
</head>

<body>
    <div class="nav">
        <div class="logo">
            <i class="bi bi-globe2"></i>
            <button type="button">UPGRADE</button>
            <div class="profit">
                <a href="">
                    <p>PROFIT PER HOUR</p>
                    <div class="profitCoin">
                        <p>
                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M10 5C10 7.76142 7.76142 10 5 10C2.23858 10 0 7.76142 0 5C0 2.23858 2.23858 0 5 0C7.76142 0 10 2.23858 10 5Z"
                                    fill="#FFA619" />
                                <path
                                    d="M6.91309 4.71289C7.04492 4.75391 7.16504 4.8125 7.27344 4.88867C7.38184 4.96484 7.47412 5.06299 7.55029 5.18311C7.62646 5.30029 7.68506 5.43945 7.72607 5.60059C7.76709 5.76172 7.7876 5.94629 7.7876 6.1543V6.4707C7.7876 7.49023 7.27783 8 6.2583 8H2.80859V1.69824H6.07812C7.09766 1.69824 7.60742 2.20947 7.60742 3.23193V3.34619C7.60742 3.70068 7.55029 3.99072 7.43604 4.21631C7.32471 4.43896 7.15039 4.60449 6.91309 4.71289ZM3.69189 5.25342V7.1167H6.23193C6.46924 7.1167 6.64062 7.06104 6.74609 6.94971C6.85156 6.83838 6.9043 6.66406 6.9043 6.42676V5.93896C6.9043 5.69873 6.85156 5.52441 6.74609 5.41602C6.64062 5.30762 6.46924 5.25342 6.23193 5.25342H3.69189ZM3.69189 2.58154V4.37451H6.11328C6.33008 4.36572 6.48535 4.30713 6.5791 4.19873C6.67578 4.0874 6.72412 3.91748 6.72412 3.68896V3.27588C6.72412 3.03564 6.67139 2.85986 6.56592 2.74854C6.46045 2.63721 6.28906 2.58154 6.05176 2.58154H3.69189Z"
                                    fill="black" />
                            </svg>
                            +
                            <span>{{ profit }}</span>
                            <span>k</span>
                        </p>
                    </div>
                </a>
            </div>
        </div>
    </div>
    <div class="user">
        <div class="icon">
            <i class="bi bi-person-fill"></i>
        </div>
        <div class="levels">
            <p class="name">{{ session.get('nickname') }}</p>
            <div class="level">
                <div class="grade" style="width: {{ progress }}%;"></div>
            </div>
            <div class="number">
                <a href="{{ url_for('level') }}">
                    <p class="num">LEVEL <span class="userLevel">{{ session.get('level') }}</span></p>
                </a>
            </div>
        </div>
    </div>
    <div class="main">
        <div class="background"></div>
        <div class="circle c1"></div>
        <div class="circle c2"></div>
        <div class="circle c3"></div>
        <div class="fixing">
            <form action="#">
                <div class="input">
                    <input type="text" placeholder="SEARCH..." id="input">
                </div>
            </form>
            <div class="sortby">
                SORT BY:
            </div>
            <div class="sort">
                <button type="button" id="vip" onclick="filterVip()">VIP</button>
                <button type="button" id="price" onclick="sortByPrice()">PRICE</button>
            </div>
        </div>
        <div class="nfts" id="nft-list">
            {% for nft in nfts %}
            <div class="nft" data-id="{{ nft.id }}" data-price="{{ nft.price }}" data-vip="{{ 'vip' if nft.is_vip else '' }}">
                <div class="txt">
                    <img src="{{ url_for('static', filename='uploads/nfts/' + nft.image) }}" alt="{{ nft.name }}">
                    <div>
                        <span class="nftName">{{ nft.name }}</span>
                        <div class="description">{{ nft.description }}</div>
                        <div class="owner">Owned by: {{ nft.owner.nickname if nft.owner else 'None' }}</div> <!-- Owner display -->
                    </div>
                </div>
                <div class="coin">
                    <span>PROFIT:</span>
                    <span class="pro">{{ nft.profit | format_thousands }}</span>
                    <button type="button" onclick="openModal(this)">
                        <span class="nftCoin">{{ nft.price | format_thousands }}</span>
                        <span>
                            <img src="{{ url_for('static', filename='img/Untitled-2.png') }}" alt="">
                        </span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Modal Structure -->
        <div id="nft-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <img src="" alt="NFT" class="modal-nft-image">
                <h3 id="modal-name"></h3>
                <p id="description"></p>
                <p>Profit: <span id="profit"></span></p>
                <p>Price: <span id="coin"></span> Coins</p>
                <button type="button" class="modal-button" onclick="purchaseNFT()">Go Ahead</button>
            </div>
        </div>
        <div class="menu">
            <div class="items">
                <ul>
                    <li> <a href="{{ url_for('tasks') }}" title="tasks"><i class="bi bi-patch-check-fill"></i></a></li>
                    <li> <a href="{{ url_for('nfts') }}" title="nft"><i class="bi bi-ui-checks-grid"></i></a></li>
                    <li><a href="{{ url_for('home') }}" title="home"><i class="bi bi-house-fill"></i></a></li>
                    <li><a href="{{ url_for('invite') }}" title="invits"><i class="bi bi-people-fill"></i></a></li>
                    <li><a href="{{ url_for('wallet') }}" title="wallet"><i class="bi bi-wallet-fill"></i></a></li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        // Function to open the modal
        function openModal(button) {
            // Get the modal element
            const modal = document.getElementById('nft-modal');

            // Get the card element containing the clicked button
            const nft = button.closest('.nft');

            // Extract data from the card
            const name = nft.querySelector('.nftName').textContent;
            const description = nft.querySelector('.description').textContent;
            const profit = nft.querySelector('.pro').textContent;
            const coin = button.querySelector('.nftCoin').textContent;
            const imageSrc = nft.querySelector('img').getAttribute('src'); // Get the image source

            // Insert data into the modal
            document.getElementById('modal-name').textContent = name;
            document.getElementById('description').textContent = description;
            document.getElementById('profit').textContent = profit;
            document.getElementById('coin').textContent = coin;
            document.querySelector('.modal-nft-image').setAttribute('src', imageSrc); // Set the image source

            // Store the NFT ID on the button
            document.querySelector('.modal-button').dataset.nftId = nft.dataset.id;

            // Show the modal
            modal.style.display = 'block';
        }

        // Function to close the modal
        function closeModal() {
            document.getElementById("nft-modal").style.display = "none";
        }

        // Close the modal if the user clicks outside of it
        window.onclick = function(event) {
            const modal = document.getElementById("nft-modal");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Function to purchase the NFT
        function purchaseNFT() {
            const nftId = document.querySelector('.modal-button').dataset.nftId;

            const formData = new FormData();
            formData.append('nft_id', nftId);

            fetch('{{ url_for("purchase_nft") }}', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.text())
            .then(data => {
                location.reload();  // Reload the page to update the NFT ownership and user coins
            });
        }

        // Function to filter and display only VIP NFTs
        function filterVip() {
            const nfts = document.querySelectorAll('.nft');
            nfts.forEach(nft => {
                if (nft.dataset.vip === 'vip') {
                    nft.style.display = 'block';
                } else {
                    nft.style.display = 'none';
                }
            });
        }

        // Function to sort and display NFTs by price
        function sortByPrice() {
            const nfts = Array.from(document.querySelectorAll('.nft'));
            const sortedNfts = nfts.sort((a, b) => parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
            const nftList = document.getElementById('nft-list');

            nftList.innerHTML = ''; // Clear the current list
            sortedNfts.forEach(nft => {
                nft.style.display = 'block'; // Ensure all are displayed
                nftList.appendChild(nft); // Re-append in sorted order
            });
        }
    </script>
</body>

</html>
